// This is your new schema.prisma file
// Changes for v1.3 are marked with comments.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  ADMIN
  AFFILIATE
  CONSUMER
}

enum OrderStatus {
  PENDING_PAYMENT
  PAYMENT_CONFIRMED
  SOURCING
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum DeletionEntityType {
  PAYMENT
  POOL_MEMBER
}

enum PoolStatus {
  FILLING
  CLOSED
  SHIPPING // This status will now be triggered by a Shipment
  READY_FOR_PICKUP
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  MPESA
  STRIPE
  AIRTEL_MONEY
}

enum SourcingStatus {
  PENDING
  RESEARCHING
  SOURCED
  REJECTED
}

// --- NEW (v1.3): For Container Sharing ---
enum ShipmentStatus {
  PLANNING // Admin is adding pools to this shipment
  LOCKED // Admin has finalized the shipment, ready for transit
  IN_TRANSIT
  ARRIVED // Arrived at port
  CLEARED // Cleared customs, ready for last-mile
}

//////////////////////
// MODELS
//////////////////////

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  password_hash String
  role          UserRole @default(CONSUMER)
  phone         String?  @unique

  // --- MODIFIED (v1.3): Replaced by UserAddress model ---
  // address       String? // Deprecated
  // location      String? // Deprecated

  emailVerified         Boolean  @default(false)
  emailVerificationToken String?  @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // --- NEW (v1.3): Account Balance ---
  accountBalance Float    @default(0)

  // relations
  orders              Order[]
  affiliate           Affiliate?
  pricingLogs         PriceCalculationLog[] @relation("UserPriceCalcLogs")
  pricingRequests     PricingRequest[]
  refreshTokens       RefreshToken[]
  PricingLog          PricingLog[]
  createdPools        Pool[]                @relation("CreatedPools")
  poolMemberships     PoolMember[]
  reviews             Review[]
  aiLogs              AiSuggestionLog[]
  passwordResetTokens PasswordResetToken[]
  sourcingRequests    SourcingRequest[]
  reviewLikes         ReviewLike[]

  // --- NEW (v1.3): Relation to saved addresses ---
  addresses           UserAddress[]
}

// --- NEW (v1.3): For saved user addresses (Point 5) ---
model UserAddress {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String // e.g., "Home", "Work"
  addressLine1 String // e.g., "Plaza Towers, Apt 12"
  town         String // e.g., "Nyeri" (from KenyanTown)
  county       String // e.g., "Nyeri" (from KenyanTown)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId])
}

// --- NEW (v1.3): For preloading Kenyan towns (Point 5) ---
model KenyanTown {
  id     String @id @default(cuid())
  name   String // e.g., "Nyeri", "Ruiru"
  county String // e.g., "Nyeri", "Kiambu"

  @@unique([name, county])
  @@index([county])
}

// --- NEW (v1.3): For delivery cost calculation (Point 6) ---
model DeliveryRate {
  id        String @id @default(cuid())
  county    String @unique // e.g., "Nairobi", "Kiambu"
  baseRate  Float // Base fee for this county
  ratePerKg Float // Additional fee per Kg
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model Affiliate {
  id             String   @id @default(cuid())
  userId         String   @unique
  code           String   @unique
  commissionRate Float    @default(0.05)
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id])
}

model Payment {
  id                       String        @id @default(cuid())
  orderId                  String?
  amount                   Float
  status                   PaymentStatus @default(PENDING)
  method                   PaymentMethod
  providerConfirmationCode String?
  providerTransactionId    String?       @unique
  transaction_date         DateTime?
  metadata                 Json?
  createdAt                DateTime      @default(now())
  order                    Order?        @relation(fields: [orderId], references: [id])
  poolMember               PoolMember?   @relation("PaymentToPoolMember")
  // Note: The poolMember relation is on the PoolMember model (paymentId).
  // If a PoolMember is deleted, this relation will be null.
  // This is likely why the admin panel shows "deleted" - it's a frontend
  // rendering issue, not a schema issue.

  @@index([orderId])
}

model Product {
  id             String   @id @default(cuid())
  name           String
  hsCode         String
  basePrice      Float // NEGOTIATED WHOLESALE (EXW/FOB) price
  benchmarkPrice Float // "AliExpress" or individual benchmark price
  weightKg       Float
  defaultRoute   String

  // --- NEW (v1.3): For Container Sharing (Volume in Cubic Meters) ---
  volumeCBM      Float    @default(0)

  createdAt      DateTime @default(now())

  // relations
  orders         Order[]
  pools          Pool[]
  categoryId     String
  subcategoryId  String
  category       Category    @relation(fields: [categoryId], references: [id])
  subcategory    Subcategory @relation(fields: [subcategoryId], references: [id])
  reviews        Review[]
}

// REPLACED 'FreightRate' with 'LogisticsRoute'
model LogisticsRoute {
  id                    String   @id @default(cuid())
  name                  String   @unique // e.g., "20-ft Container, Shenzhen to Mombasa"
  seaFreightCost        Float
  originCharges         Float
  portChargesMombasa    Float
  clearingAgentFee      Float
  inlandTransportCost   Float
  containerDeposit      Float
  marineInsuranceRate   Float

  // --- NEW (v1.3): For Container Sharing (Capacity) ---
  capacityCBM           Float    @default(0) // e.g., 33.0 for a 20ft container
  capacityKg            Float    @default(0) // e.g., 25000 for a 20ft container

  createdAt             DateTime @default(now())

  // --- NEW (v1.3): Relation to shipments using this route type ---
  shipments             Shipment[]
}

// --- NEW (v1.3): For Container Sharing ---
// This model represents an actual, physical container shipment
// that can hold multiple pools.
model Shipment {
  id               String         @id @default(cuid())
  name             String // e.g., "Shipment 2025-11-10"
  logisticsRouteId String // The *type* of container/route being used
  logisticsRoute   LogisticsRoute @relation(fields: [logisticsRouteId], references: [id])
  status           ShipmentStatus @default(PLANNING)
  totalCBM         Float          @default(0) // Current filled CBM
  totalKg          Float          @default(0) // Current filled Kg
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // A shipment can contain many pools
  pools            Pool[]
}

model KRARate {
  id            String    @id @default(cuid())
  hsCode        String
  duty_rate     Float     @default(0)
  rdl_rate      Float     @default(0)
  idf_rate      Float     @default(0)
  vat_rate      Float     @default(0)
  description   String?
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())

  @@unique([hsCode, effectiveFrom])
  @@index([hsCode])
}

model PriceCalculationLog {
  id          String   @id @default(cuid())
  userId      String?
  basePrice   Float
  distanceKm  Float
  weightKg    Float
  route       String?
  hsCode      String?
  freightRate Float?
  duty_rate   Float?
  rdl_rate    Float?
  idf_rate    Float?
  vat_rate    Float?
  taxesTotal  Float?
  commission  Float?
  finalPrice  Float
  createdAt   DateTime @default(now())
  user        User?    @relation("UserPriceCalcLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([hsCode])
  @@index([route])
}

model PricingRequest {
  id        String   @id @default(cuid())
  userId    String?
  payload   Json
  result    Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  pools     Pool[]
}

model Order {
  id              String      @id @default(cuid())
  order_number    String      @unique
  userId          String
  productId       String
  status          OrderStatus @default(PENDING_PAYMENT)
  final_price_ksh Float?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user          User                 @relation(fields: [userId], references: [id])
  product       Product              @relation(fields: [productId], references: [id])
  payments      Payment[]
  statusHistory OrderStatusHistory[]

  @@index([userId])
  @@index([order_number])
}

model OrderStatusHistory {
  id         String      @id @default(cuid())
  orderId    String
  fromStatus OrderStatus
  toStatus   OrderStatus
  note       String?
  createdAt  DateTime    @default(now())
  order      Order       @relation(fields: [orderId], references: [id])

  @@index([orderId])
}

model PricingLog {
  id         String   @id @default(cuid())
  basePrice  Float
  distanceKm Float
  weightKg   Float
  finalPrice Float
  userId     String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}

model Pool {
  id              String     @id @default(cuid())
  title           String
  description     String?
  imageUrls       String[]
  productId       String
  pricePerUnit    Float
  targetQuantity  Int
  minJoiners      Int        @default(1)
  currentQuantity Int        @default(0)
  profitMargin    Float?
  progress        Float?     @default(0)
  cumulativeValue Float?     @default(0)
  deadline        DateTime
  status          PoolStatus @default(FILLING)
  createdById     String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  product      Product      @relation(fields: [productId], references: [id])
  creator      User         @relation("CreatedPools", fields: [createdById], references: [id])
  members      PoolMember[]
  finance      PoolFinance? @relation("PoolToFinance")
  reviews      Review[]

  // --- NEW (v1.3): Relation to a container/shipment ---
  shipmentId   String?
  shipment     Shipment?    @relation(fields: [shipmentId], references: [id])
  pricingRequestId String?
  pricingRequest   PricingRequest? @relation(fields: [pricingRequestId], references: [id])

  @@index([status])
  @@index([createdById])
  @@index([productId])
  @@index([shipmentId]) // Add index for new relation
}

model PoolFinance {
  id                       String    @id @default(cuid())
  poolId                   String    @unique
  baseCostPerUnit          Float
  benchmarkPricePerUnit    Float?
  totalFixedCosts          Float? // The total container/shipping/port costs
  totalVariableCostPerUnit Float? // The per-unit cost (wholesale + tax + insurance)
  calculationDebugData     Json?
  logisticCost             Float?    @default(0)
  totalRevenue             Float?    @default(0)
  totalCost                Float?    @default(0)
  grossProfit              Float?    @default(0)
  platformFee              Float?    @default(0.05)
  platformEarning          Float?    @default(0)
  memberSavings            Float?    @default(0)
  isFinalized              Boolean   @default(false)
  finalizedAt              DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  pool          Pool            @relation("PoolToFinance", fields: [poolId], references: [id])
  AdminEarnings AdminEarnings[]
}

model PoolMember {
  id        String   @id @default(cuid())
  poolId    String
  userId    String
  quantity  Int      @default(1)
  paymentId String?  @unique
  joinedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  pool      Pool     @relation(fields: [poolId], references: [id])
  payment   Payment? @relation("PaymentToPoolMember", fields: [paymentId], references: [id])

  @@index([poolId])
  @@index([userId])
}

model DeletionLog {
  id         String             @id @default(cuid())
  entityType DeletionEntityType
  entityId   String
  reason     String
  metadata   Json?
  deletedAt  DateTime           @default(now())

  @@index([entityType, entityId])
}

model AdminEarnings {
  id            String      @id @default(cuid())
  poolFinanceId String
  amount        Float
  description   String?
  createdAt     DateTime    @default(now())
  poolFinance   PoolFinance @relation(fields: [poolFinanceId], references: [id])

  @@index([poolFinanceId])
}

model Category {
  id            String        @id @default(cuid())
  name          String        @unique
  subcategories Subcategory[]
  products      Product[]
}

model Subcategory {
  id         String    @id @default(cuid())
  name       String
  categoryId String
  category   Category  @relation(fields: [categoryId], references: [id])
  products   Product[]

  @@index([categoryId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  poolId    String?
  pool      Pool?    @relation(fields: [poolId], references: [id])
  likes     ReviewLike[]
  parentId  String?     @map("parent_id")
  parent    Review?     @relation("ReviewReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Review[]    @relation("ReviewReplies")

  @@index([userId])
  @@index([productId])
  @@index([poolId])
  @@index([parentId])
}

model ReviewLike {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewId String
  review   Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, reviewId])
}

model GlobalSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  notes     String?
  updatedAt DateTime @updatedAt
}

model AiSuggestionLog {
  id                 String   @id @default(cuid())
  userId             String?
  productDescription String
  hsCode             String
  confidence         String
  reasoning          String?
  createdAt          DateTime @default(now())
  user               User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([hsCode])
}

model SourcingRequest {
  id                 String         @id @default(cuid())
  userId             String
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  productDescription String
  status             SourcingStatus @default(PENDING)
  notes              String?
  hsCode             String?
  basePrice          Float?
  benchmarkPrice     Float?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([userId])
  @@index([status])
}