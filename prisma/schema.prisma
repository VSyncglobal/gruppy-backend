// This is your new schema.prisma file
// Phase 1: Re-architected for "Atomic Settlement" and "Admin Bulk Order" logic.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  ADMIN
  AFFILIATE
  CONSUMER
}

// --- DELETED (v_phase1): OrderStatus enum is no longer needed ---
// enum OrderStatus { ... }

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum DeletionEntityType {
  PAYMENT
  POOL_MEMBER
}

enum PoolStatus {
  FILLING
  CLOSED
  SHIPPING
  READY_FOR_PICKUP
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  MPESA
  STRIPE
  AIRTEL_MONEY
  ACCOUNT_BALANCE // --- NEW (v_phase1): Added for internal transactions
}

enum SourcingStatus {
  PENDING
  RESEARCHING
  SOURCED
  REJECTED
}

enum ShipmentStatus {
  PLANNING
  LOCKED
  IN_TRANSIT
  ARRIVED
  CLEARED
}

// --- NEW (v_phase1): For Admin Bulk Orders ---
enum BulkOrderStatus {
  PENDING_SUPPLIER_PAYMENT
  ORDERED
  SHIPPED
  RECEIVED
  CANCELLED
}

//////////////////////
// MODELS
//////////////////////

model User {
  id                   String   @id @default(cuid())
  name                 String
  email                String   @unique
  password_hash        String
  role                 UserRole @default(CONSUMER)
  phone                String?  @unique
  emailVerified        Boolean  @default(false)
  emailVerificationToken String?  @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  accountBalance       Float    @default(0)

  // relations
  affiliate           Affiliate?
  pricingLogs         PriceCalculationLog[] @relation("UserPriceCalcLogs")
  pricingRequests     PricingRequest[]
  refreshTokens       RefreshToken[]
  PricingLog          PricingLog[]
  createdPools        Pool[]                @relation("CreatedPools")
  poolMemberships     PoolMember[]
  reviews             Review[]
  aiLogs              AiSuggestionLog[]
  passwordResetTokens PasswordResetToken[]
  sourcingRequests    SourcingRequest[]
  reviewLikes         ReviewLike[]
  addresses           UserAddress[]
  
  // --- NEW (v_phase1): Relation to failed attempts for user history ---
  failedJoinAttempts  FailedJoinAttempt[]

  // --- DELETED (v_phase1): Removed relation to old Order table ---
  // orders              Order[]
}

model UserAddress {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String // e.g., "Home", "Work"
  addressLine1 String // e.g., "Plaza Towers, Apt 12"
  town         String // e.g., "Nyeri" (from KenyanTown)
  county       String // e.g., "Nyeri" (from KenyanTown)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId])
}

model KenyanTown {
  id     String @id @default(cuid())
  name   String // e.g., "Nyeri", "Ruiru"
  county String // e.g., "Nyeri", "Kiambu"

  @@unique([name, county])
  @@index([county])
}

model DeliveryRate {
  id        String @id @default(cuid())
  county    String @unique // e.g., "Nairobi", "Kiambu"
  baseRate  Float // Base fee for this county
  ratePerKg Float // Additional fee per Kg
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model Affiliate {
  id             String   @id @default(cuid())
  userId         String   @unique
  code           String   @unique
  commissionRate Float    @default(0.05)
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete
}

model Payment {
  id                       String        @id @default(cuid())
  amount                   Float
  status                   PaymentStatus @default(PENDING)
  method                   PaymentMethod
  providerConfirmationCode String?
  providerTransactionId    String?       @unique
  transaction_date         DateTime?
  metadata                 Json?
  createdAt                DateTime      @default(now())
  
  // --- NEW (v_phase1): Fields for tracking revenue streams ---
  deliveryFee        Float    @default(0)
  amountFromBalance  Float    @default(0)

  // --- NEW (v_phase1): Relation to the PoolMember (One-to-Many) ---
  poolMemberId String?
  poolMember   PoolMember? @relation(fields: [poolMemberId], references: [id])

  // --- DELETED (v_phase1): Removed old Order relation ---
  // orderId                  String?
  // order                    Order?        @relation(fields: [orderId], references: [id])
  
  // --- DELETED (v_phase1): Removed old incorrect PoolMember relation ---
  // poolMember               PoolMember?   @relation("PaymentToPoolMember")

  @@index([poolMemberId])
}

model Product {
  id             String   @id @default(cuid())
  name           String
  hsCode         String
  basePrice      Float
  benchmarkPrice Float
  weightKg       Float
  defaultRoute   String
  volumeCBM      Float    @default(0)
  createdAt      DateTime @default(now())

  // relations
  pools          Pool[]
  categoryId     String
  subcategoryId  String
  category       Category    @relation(fields: [categoryId], references: [id])
  subcategory    Subcategory @relation(fields: [subcategoryId], references: [id])
  reviews        Review[]
  
  // --- DELETED (v_phase1): Removed relation to old Order table ---
  // orders         Order[]
}

model LogisticsRoute {
  id                  String   @id @default(cuid())
  name                String   @unique
  seaFreightCost      Float
  originCharges       Float
  portChargesMombasa  Float
  clearingAgentFee    Float
  inlandTransportCost Float
  containerDeposit    Float
  marineInsuranceRate Float
  capacityCBM         Float    @default(0)
  capacityKg          Float    @default(0)
  createdAt           DateTime @default(now())
  shipments           Shipment[]
}

model Shipment {
  id               String         @id @default(cuid())
  name             String
  logisticsRouteId String
  logisticsRoute   LogisticsRoute @relation(fields: [logisticsRouteId], references: [id])
  status           ShipmentStatus @default(PLANNING)
  totalCBM         Float          @default(0)
  totalKg          Float          @default(0)

  // --- NEW (v_phase1): Added fields from upgrade plan ---
  trackingNumber   String?
  notes            String?
  departureDate    DateTime?
  arrivalDate      DateTime?
  // --- END NEW FIELDS ---

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  pools            Pool[]
}

model KRARate {
  id            String    @id @default(cuid())
  hsCode        String
  duty_rate     Float     @default(0)
  rdl_rate      Float     @default(0)
  idf_rate      Float     @default(0)
  vat_rate      Float     @default(0)
  description   String?
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())

  @@unique([hsCode, effectiveFrom])
  @@index([hsCode])
}

model PriceCalculationLog {
  id          String   @id @default(cuid())
  userId      String?
  basePrice   Float
  distanceKm  Float
  weightKg    Float
  route       String?
  hsCode      String?
  freightRate Float?
  duty_rate   Float?
  rdl_rate    Float?
  idf_rate    Float?
  vat_rate    Float?
  taxesTotal  Float?
  commission  Float?
  finalPrice  Float
  createdAt   DateTime @default(now())
  user        User?    @relation("UserPriceCalcLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([hsCode])
  @@index([route])
}

model PricingRequest {
  id        String   @id @default(cuid())
  userId    String?
  payload   Json
  result    Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  pools     Pool[]
}

// --- DELETED (v_phase1): Replaced by PoolMember and BulkOrder ---
// model Order { ... }
// model OrderStatusHistory { ... }

model PricingLog {
  id         String   @id @default(cuid())
  basePrice  Float
  distanceKm Float
  weightKg   Float
  finalPrice Float
  userId     String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}

model Pool {
  id              String     @id @default(cuid())
  title           String
  description     String?
  imageUrls       String[]
  productId       String
  pricePerUnit    Float
  targetQuantity  Int
  minJoiners      Int        @default(1)
  currentQuantity Int        @default(0)
  profitMargin    Float?
  progress        Float?     @default(0)
  cumulativeValue Float?     @default(0)
  deadline        DateTime
  status          PoolStatus @default(FILLING)
  createdById     String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  product          Product         @relation(fields: [productId], references: [id])
  creator          User            @relation("CreatedPools", fields: [createdById], references: [id])
  members          PoolMember[]
  finance          PoolFinance?    @relation("PoolToFinance")
  reviews          Review[]
  shipmentId       String?
  shipment         Shipment?       @relation(fields: [shipmentId], references: [id])
  pricingRequestId String?
  pricingRequest   PricingRequest? @relation(fields: [pricingRequestId], references: [id])

  // --- NEW (v_phase1): Relation to the Admin's Bulk Order ---
  bulkOrder        BulkOrder?

  // --- NEW (v_phase1): Relation for failed attempts audit trail ---
  failedJoinAttempts FailedJoinAttempt[]

  @@index([status])
  @@index([createdById])
  @@index([productId])
  @@index([shipmentId])
}

// --- NEW (v_phase1): Admin's Bulk Order table ---
model BulkOrder {
  id                      String        @id @default(cuid())
  poolId                  String        @unique
  pool                    Pool          @relation(fields: [poolId], references: [id])
  status                  BulkOrderStatus @default(PENDING_SUPPLIER_PAYMENT)
  totalOrderCostKES       Float // (costPerItem * quantity) @ exchangeRate
  totalLogisticsCostKES   Float // (PoolFinance.totalFixedCosts)
  totalTaxesKES           Float // (Calculated taxes for the bulk order)
  costPerItemUSD          Float
  exchangeRate            Float
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
}

// --- NEW (v_phase1): Audit table for failed/expired joins ---
model FailedJoinAttempt {
  id                String        @id @default(cuid())
  reason            String // e.g., "EXPIRED_PENDING", "USER_CANCELED", "NEW_JOIN_ATTEMPT"
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  poolId            String
  pool              Pool          @relation(fields: [poolId], references: [id])
  quantity          Int
  totalAmount       Float // Total value of the attempt (items + delivery)
  deliveryFee       Float
  amountFromBalance Float
  paymentMethod     PaymentMethod // The method that was pending/failed
  providerMetadata  Json? // The error response from M-Pesa, etc.
  createdAt         DateTime      @default(now())

  @@index([userId])
  @@index([poolId])
}

model PoolFinance {
  id                       String    @id @default(cuid())
  poolId                   String    @unique
  baseCostPerUnit          Float
  benchmarkPricePerUnit    Float?
  totalFixedCosts          Float?
  totalVariableCostPerUnit Float?
  calculationDebugData     Json?
  logisticCost             Float?    @default(0)
  totalRevenue             Float?    @default(0)
  totalCost                Float?    @default(0)
  grossProfit              Float?    @default(0)
  platformFee              Float?    @default(0.05)
  platformEarning          Float?    @default(0)
  memberSavings            Float?    @default(0)
  isFinalized              Boolean   @default(false)
  finalizedAt              DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  pool          Pool            @relation("PoolToFinance", fields: [poolId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete
  AdminEarnings AdminEarnings[]
}

model PoolMember {
  id       String   @id @default(cuid())
  poolId   String
  userId   String
  quantity Int      @default(1)
  joinedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id])
  pool     Pool     @relation(fields: [poolId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete

  // --- NEW (v_phase1): Replaced one-to-one with one-to-many ---
  payments Payment[]
  
  // --- DELETED (v_phase1): Removed old one-to-one relation ---
  // paymentId String?  @unique
  // payment   Payment? @relation("PaymentToPoolMember", fields: [paymentId], references: [id])

  @@index([poolId])
  @@index([userId])
}

model DeletionLog {
  id         String             @id @default(cuid())
  entityType DeletionEntityType
  entityId   String
  reason     String
  metadata   Json?
  deletedAt  DateTime           @default(now())

  @@index([entityType, entityId])
}

model AdminEarnings {
  id            String      @id @default(cuid())
  poolFinanceId String
  amount        Float
  description   String?
  createdAt     DateTime    @default(now())
  poolFinance   PoolFinance @relation(fields: [poolFinanceId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete

  @@index([poolFinanceId])
}

model Category {
  id            String        @id @default(cuid())
  name          String        @unique
  subcategories Subcategory[]
  products      Product[]
}

model Subcategory {
  id         String    @id @default(cuid())
  name       String
  categoryId String
  category   Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete
  products   Product[]

  @@index([categoryId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // --- Changed to Cascade delete
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull) // --- Changed to SetNull
  poolId    String?
  pool      Pool?    @relation(fields: [poolId], references: [id], onDelete: SetNull) // --- Changed to SetNull
  likes     ReviewLike[]
  parentId  String?     @map("parent_id")
  parent    Review?     @relation("ReviewReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Review[]    @relation("ReviewReplies")

  @@index([userId])
  @@index([productId])
  @@index([poolId])
  @@index([parentId])
}

model ReviewLike {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, reviewId])
}

model GlobalSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  notes     String?
  updatedAt DateTime @updatedAt
}

model AiSuggestionLog {
  id                 String   @id @default(cuid())
  userId             String?
  productDescription String
  hsCode             String
  confidence         String
  reasoning          String?
  createdAt          DateTime @default(now())
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull) // --- Changed to SetNull

  @@index([userId])
  @@index([hsCode])
}

model SourcingRequest {
  id                 String         @id @default(cuid())
  userId             String
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  productDescription String
  status             SourcingStatus @default(PENDING)
  notes              String?
  hsCode             String?
  basePrice          Float?
  benchmarkPrice     Float?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([userId])
  @@index([status])
}